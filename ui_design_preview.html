<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>StoryTrim App</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@300;400;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; background-color: #fafaf9; }
        .font-serif-sc { font-family: 'Noto Serif SC', serif; }

        /* éšè—æ»šåŠ¨æ¡ */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Vue è¿‡æ¸¡åŠ¨ç”» */
        .fade-enter-active, .fade-leave-active { transition: opacity 0.3s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }

        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s ease-out; }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
    </style>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        stone: { 50: '#fafaf9', 100: '#f5f5f4', 800: '#292524', 900: '#1c1917' },
                        teal: { 500: '#14b8a6', 600: '#0d9488', 50: '#f0fdfa' }
                    },
                    spacing: {
                        'safe-bottom': 'env(safe-area-inset-bottom)'
                    }
                }
            }
        }
    </script>
</head>
<body class="h-screen w-full overflow-hidden text-stone-800">

<div id="app" class="h-full w-full relative">

    <transition name="fade">
        <div v-if="currentView === 'shelf'" class="h-full flex flex-col p-6 sm:p-8 overflow-y-auto pb-24">

            <header class="flex justify-between items-center mb-8">
                <div class="flex items-center gap-2">
                    <div class="bg-stone-900 text-white p-1.5 rounded-lg">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>
                    </div>
                    <span class="text-xl font-bold tracking-tight">StoryTrim</span>
                </div>
                <div class="w-8 h-8 rounded-full bg-stone-200 flex items-center justify-center text-stone-500 font-bold text-xs">User</div>
            </header>

            <div @click="triggerUpload" class="mb-8 border-2 border-dashed border-stone-200 rounded-2xl p-8 flex flex-col items-center justify-center text-center hover:border-teal-400 hover:bg-teal-50 transition-colors cursor-pointer group">
                <div class="w-12 h-12 bg-white rounded-full shadow-sm flex items-center justify-center mb-3 group-hover:scale-110 transition-transform text-teal-500">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                </div>
                <h3 class="font-bold text-stone-700">å¯¼å…¥æ–°ä¹¦</h3>
                <p class="text-xs text-stone-400 mt-1">æ”¯æŒ .txt / .epub</p>
            </div>

            <h3 class="text-sm font-bold text-stone-400 uppercase tracking-wider mb-4">æˆ‘çš„ä¹¦æ¶</h3>
            <div class="grid grid-cols-1 gap-4">
                <div v-for="book in books" :key="book.id" @click="handleBookClick(book)" class="bg-white p-4 rounded-xl shadow-sm border border-stone-100 flex items-center gap-4 active:scale-[0.98] transition-transform">
                    <div class="w-12 h-16 bg-stone-100 rounded flex items-center justify-center text-[10px] text-stone-300 font-serif">
                        å°é¢
                    </div>

                    <div class="flex-1 min-w-0">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-stone-800 truncate">{{ book.title }}</h4>
                            <div class="flex items-center gap-1.5 bg-stone-50 px-2 py-1 rounded-full border border-stone-100">
                                <div :class="{
                                        'bg-teal-500': book.status === 'ready',
                                        'bg-yellow-400 animate-pulse': book.status === 'processing',
                                        'bg-stone-300': book.status === 'new'
                                    }" class="w-2 h-2 rounded-full"></div>
                                <span class="text-[10px] text-stone-500 font-medium">
                                        {{ getStatusText(book.status) }}
                                    </span>
                            </div>
                        </div>
                        <p class="text-xs text-stone-400 mt-1 truncate">{{ book.lastChapter }}</p>
                        <div class="w-full bg-stone-100 h-1 mt-3 rounded-full overflow-hidden">
                            <div class="bg-stone-300 h-full rounded-full" :style="{ width: book.progress + '%' }"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </transition>

    <transition name="fade">
        <div v-if="currentView === 'reader'" class="h-full w-full flex flex-col relative bg-[#fafaf9]">

            <div :class="menuVisible ? 'translate-y-0' : '-translate-y-full'" class="fixed top-0 inset-x-0 h-14 bg-white/95 backdrop-blur z-30 flex items-center justify-between px-4 shadow-sm transition-transform duration-300">
                <button @click="currentView = 'shelf'" class="p-2 text-stone-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg></button>
                <span class="font-bold text-sm truncate max-w-[200px]">{{ activeBook?.title }}</span>
                <button class="p-2 text-stone-500"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h.01M12 12h.01M19 12h.01M6 12a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0zm7 0a1 1 0 11-2 0 1 1 0 012 0z"></path></svg></button>
            </div>

            <main @click="menuVisible = !menuVisible" class="flex-1 overflow-y-auto p-6 pb-32 sm:px-12 scroll-smooth" id="reader-content">
                <article class="prose prose-lg prose-stone max-w-2xl mx-auto font-serif-sc text-justify leading-loose mt-8">
                    <h2 class="text-2xl font-bold mb-8 text-center">{{ activeBook?.lastChapter }}</h2>

                    <div class="transition-opacity duration-300" :class="{ 'opacity-0': isTextTransitioning, 'opacity-100': !isTextTransitioning }">
                        <p v-for="(para, index) in currentDisplayText" :key="index" class="mb-4">{{ para }}</p>
                    </div>
                </article>
            </main>

            <div :class="menuVisible ? 'translate-y-0' : 'translate-y-full'" class="fixed bottom-0 inset-x-0 bg-white/95 backdrop-blur z-30 border-t border-stone-100 transition-transform duration-300 pb-safe">
                <div class="h-16 flex justify-around items-center max-w-md mx-auto relative">

                    <button class="flex flex-col items-center gap-1 text-stone-400 p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7"></path></svg>
                        <span class="text-[10px]">ç›®å½•</span>
                    </button>

                    <div class="relative -top-6">
                        <button @click="toggleMagic"
                                :class="isMagicActive ? 'bg-teal-500 text-white shadow-teal-500/40' : 'bg-stone-200 text-stone-400 shadow-none'"
                                class="w-14 h-14 rounded-full flex items-center justify-center shadow-lg transition-all transform active:scale-95">
                            <svg class="w-7 h-7" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        </button>
                        <div v-if="menuVisible" class="absolute -bottom-6 left-1/2 -translate-x-1/2 whitespace-nowrap text-[10px] font-medium text-stone-400">
                            {{ isMagicActive ? activeBook?.activeModeName : 'åŸæ–‡' }}
                        </div>
                    </div>

                    <button @click="showSettings = true" class="flex flex-col items-center gap-1 text-stone-400 p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        <span class="text-[10px]">è®¾ç½®</span>
                    </button>
                </div>
            </div>
        </div>
    </transition>

    <transition name="slide-up">
        <div v-if="showConfigModal" class="fixed inset-0 z-50 flex items-end sm:items-center justify-center bg-black/30 backdrop-blur-sm p-4">
            <div @click.stop class="bg-white w-full max-w-md rounded-2xl shadow-2xl overflow-hidden mb-4 sm:mb-0">
                <div class="p-6 pb-2">
                    <h3 class="text-xl font-bold text-stone-800">AI ç²¾ç®€è®¾ç½®</h3>
                    <p class="text-sm text-stone-500 mt-1">é€‰æ‹©ä¸€ç§æ¨¡å¼æ¥å¤„ç†ã€Š{{ tempBook?.title }}ã€‹</p>
                </div>

                <div class="p-6 space-y-3">
                    <div v-for="mode in availableModes" :key="mode.id"
                         @click="selectedModeId = mode.id"
                         :class="selectedModeId === mode.id ? 'border-teal-500 bg-teal-50 ring-1 ring-teal-500' : 'border-stone-200 hover:border-teal-200'"
                         class="flex items-start gap-3 p-3 border rounded-xl cursor-pointer transition-all">

                        <div :class="selectedModeId === mode.id ? 'bg-teal-100 text-teal-600' : 'bg-stone-100 text-stone-400'" class="p-2 rounded-lg shrink-0">
                            <span class="text-xl" v-html="mode.icon"></span>
                        </div>

                        <div>
                            <div class="font-bold text-sm text-stone-800">{{ mode.name }}</div>
                            <div class="text-xs text-stone-500 mt-1 leading-relaxed">{{ mode.desc }}</div>
                        </div>
                    </div>
                </div>

                <div class="p-4 bg-stone-50 border-t border-stone-100 flex gap-3">
                    <button @click="showConfigModal = false" class="flex-1 py-3 text-stone-500 font-medium text-sm rounded-xl hover:bg-stone-200">ç¨å</button>
                    <button @click="startProcess" class="flex-1 py-3 bg-stone-900 text-white font-medium text-sm rounded-xl shadow-lg hover:bg-teal-600 transition-colors flex items-center justify-center gap-2">
                        <span>å¼€å§‹ç²¾ç®€</span>
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                    </button>
                </div>
            </div>
        </div>
    </transition>


    <transition name="slide-up">
        <div v-if="showSettings" class="fixed inset-0 z-50 flex items-end justify-center">
            <div @click="showSettings = false" class="absolute inset-0 bg-black/10"></div>

            <div class="relative bg-white w-full max-w-lg rounded-t-2xl shadow-xl p-6 pb-safe z-10">
                <div class="w-12 h-1 bg-stone-200 rounded-full mx-auto mb-6"></div>

                <div class="mb-8">
                    <div class="text-xs font-bold text-stone-400 uppercase tracking-wider mb-3 flex justify-between">
                        <span>AI é˜…è¯»å±‚</span>
                        <span class="text-teal-600 font-normal cursor-pointer text-[10px]" @click="alert('åŠŸèƒ½å¼€å‘ä¸­')">+ æ–°å¢å¤„ç†</span>
                    </div>

                    <div v-if="activeBook?.status === 'ready'" class="flex gap-3 overflow-x-auto no-scrollbar pb-2">
                        <button v-for="modeKey in Object.keys(activeBook.modes)"
                                :key="modeKey"
                                @click="switchActiveMode(modeKey)"
                                :class="activeBook.activeModeName === getModeName(modeKey) ? 'bg-teal-500 text-white border-transparent' : 'bg-white text-stone-600 border-stone-200'"
                                class="px-4 py-2 rounded-full text-xs font-medium border flex-shrink-0 transition-colors">
                            {{ getModeName(modeKey) }}
                        </button>
                    </div>
                    <div v-else class="text-sm text-stone-400 italic">å½“å‰ä¹¦ç±å°šæœªè¿›è¡Œ AI å¤„ç†</div>
                </div>

                <div class="mb-8">
                    <div class="text-xs font-bold text-stone-400 uppercase tracking-wider mb-3">å­—å·</div>
                    <div class="flex items-center justify-between bg-stone-50 rounded-xl p-3">
                        <span class="text-sm font-serif px-2">A</span>
                        <input type="range" class="w-full mx-4 h-1 bg-stone-200 rounded-lg appearance-none cursor-pointer accent-teal-600">
                        <span class="text-xl font-serif px-2">A</span>
                    </div>
                </div>

                <button @click="showSettings = false" class="w-full bg-stone-100 py-3 rounded-xl text-sm font-bold text-stone-600">å…³é—­</button>
            </div>
        </div>
    </transition>

    <div class="fixed top-20 left-1/2 -translate-x-1/2 bg-stone-800/90 text-white px-4 py-2 rounded-full text-xs backdrop-blur pointer-events-none transition-opacity duration-300 z-50"
         :class="toastVisible ? 'opacity-100' : 'opacity-0'">
        {{ toastMessage }}
    </div>

</div>

<script>
    const { createApp, ref, computed, reactive } = Vue;

    createApp({
        setup() {
            // --- State ---
            const currentView = ref('shelf'); // 'shelf' | 'reader'
            const showConfigModal = ref(false);
            const showSettings = ref(false);
            const menuVisible = ref(true);
            const isMagicActive = ref(false); // æ§åˆ¶æ˜¯å¦å¼€å¯ç²¾ç®€
            const isTextTransitioning = ref(false);
            const selectedModeId = ref('dewater'); // config modal selection

            // Toast Logic
            const toastVisible = ref(false);
            const toastMessage = ref('');
            const showToast = (msg) => {
                toastMessage.value = msg;
                toastVisible.value = true;
                setTimeout(() => toastVisible.value = false, 2000);
            };

            // Data: æ¨¡æ‹Ÿä¹¦ç±æ•°æ®
            const books = reactive([
                {
                    id: 1,
                    title: 'æ–—ç ´è‹ç©¹',
                    lastChapter: 'ç¬¬ä¸€ç«  é™¨è½çš„å¤©æ‰',
                    progress: 5,
                    status: 'ready', // new, processing, ready
                    activeModeName: 'å»æ°´æ¨¡å¼',
                    // è¿™é‡Œå­˜æ”¾ä¸åŒæ¨¡å¼ä¸‹çš„æ–‡æœ¬å†…å®¹ï¼Œç”¨äºåˆ‡æ¢
                    modes: {
                        original: [
                            "â€œæ–—ä¹‹åŠ›ï¼Œä¸‰æ®µï¼â€",
                            "æœ›ç€æµ‹éªŒé­”çŸ³ç¢‘ä¸Šé¢é—ªäº®å¾—ç”šè‡³æœ‰äº›åˆºçœ¼çš„äº”ä¸ªå¤§å­—ï¼Œå°‘å¹´é¢æ— è¡¨æƒ…ï¼Œå”‡è§’æœ‰ç€ä¸€æŠ¹è‡ªå˜²ï¼Œç´§æ¡çš„æ‰‹æŒï¼Œå› ä¸ºå¤§åŠ›ï¼Œè€Œå¯¼è‡´ç•¥å¾®å°–é”çš„æŒ‡ç”²æ·±æ·±çš„åˆºè¿›äº†æŒå¿ƒä¹‹ä¸­ï¼Œå¸¦æ¥ä¸€é˜µé˜µé’»å¿ƒçš„ç–¼ç—›â€¦",
                            "â€œè§ç‚ï¼Œæ–—ä¹‹åŠ›ï¼Œä¸‰æ®µï¼çº§åˆ«ï¼šä½çº§ï¼â€æµ‹éªŒé­”çŸ³ç¢‘ä¹‹æ—ï¼Œä¸€ä½ä¸­å¹´ç”·å­ï¼Œçœ‹äº†ä¸€çœ¼ç¢‘ä¸Šæ‰€æ˜¾ç¤ºå‡ºæ¥çš„ä¿¡æ¯ï¼Œè¯­æ°”æ¼ ç„¶çš„å°†ä¹‹å…¬å¸ƒäº†å‡ºæ¥â€¦",
                            "ä¸­å¹´ç”·å­è¯åˆšåˆšè„±å£ï¼Œä¾¿æ˜¯ä¸å‡ºæ„å¤–çš„åœ¨äººå¤´æ±¹æ¶Œçš„å¹¿åœºä¸Šå¸¦èµ·äº†ä¸€é˜µå˜²è®½çš„éªšåŠ¨ã€‚",
                            "â€œä¸‰æ®µï¼Ÿå˜¿å˜¿ï¼Œæœç„¶ä¸å‡ºæˆ‘æ‰€æ–™ï¼Œè¿™ä¸ªâ€˜å¤©æ‰â€™è¿™ä¸€å¹´åˆæ˜¯åœ¨åŸåœ°è¸æ­¥ï¼â€",
                            "â€œå“ï¼Œè¿™åºŸç‰©çœŸæ˜¯æŠŠå®¶æ—çš„è„¸éƒ½ç»™ä¸¢å…‰äº†ã€‚â€"
                        ],
                        dewater: [
                            "â€œæ–—ä¹‹åŠ›ï¼Œä¸‰æ®µï¼â€",
                            "æµ‹éªŒé­”çŸ³ç¢‘ä¸Šé—ªçƒç€åˆºçœ¼çš„äº”ä¸ªå¤§å­—ã€‚å°‘å¹´é¢æ— è¡¨æƒ…ï¼Œå”‡è§’å‹¾èµ·ä¸€æŠ¹è‡ªå˜²ï¼ŒæŒ‡ç”²æ·±æ·±åµŒå…¥æŒå¿ƒï¼Œå¸¦æ¥é’»å¿ƒçš„ç—›ã€‚",
                            "â€œè§ç‚ï¼Œæ–—ä¹‹åŠ›ï¼Œä¸‰æ®µï¼çº§åˆ«ï¼šä½çº§ï¼â€æµ‹éªŒå‘˜æ¼ ç„¶å…¬å¸ƒã€‚",
                            "å¹¿åœºä¸Šé¡¿æ—¶å“èµ·ä¸€é˜µå˜²è®½çš„éªšåŠ¨ã€‚",
                            "â€œä¸‰æ®µï¼Ÿæœç„¶ï¼Œè¿™ä¸ªâ€˜å¤©æ‰â€™ä»Šå¹´è¿˜åœ¨åŸåœ°è¸æ­¥ï¼â€",
                            "â€œçœŸæ˜¯æŠŠå®¶æ—çš„è„¸éƒ½ä¸¢å°½äº†ã€‚â€"
                        ],
                        summary: [
                            "è§ç‚åœ¨å®¶æ—æµ‹è¯•ä¸­ä»…æµ‹å‡ºâ€œæ–—ä¹‹åŠ›ä¸‰æ®µâ€ï¼Œè¢«ç¡®è®¤ä¸ºä½çº§ã€‚",
                            "è¿™ä¸€ç»“æœç«‹åˆ»å¼•æ¥äº†å¹¿åœºä¼—äººçš„å˜²è®½å’Œç¾è¾±ã€‚",
                            "æ›¾ç»çš„å¤©æ‰å¦‚ä»ŠåŸåœ°è¸æ­¥ï¼Œè¢«è§†ä¸ºå®¶æ—ä¹‹è€»ã€‚"
                        ]
                    }
                },
                {
                    id: 2,
                    title: 'å‡¡äººä¿®ä»™ä¼ ',
                    lastChapter: 'ç¬¬ä¸€ç«  å±±è¾¹å°æ‘',
                    progress: 0,
                    status: 'new',
                    modes: {}
                }
            ]);

            const tempBook = ref(null); // ä¸´æ—¶é€‰ä¸­çš„ä¹¦ï¼ˆç”¨äº Config Modalï¼‰
            const activeBook = ref(null); // å½“å‰é˜…è¯»çš„ä¹¦

            // é…ç½®æ¨¡å¼é€‰é¡¹
            const availableModes = [
                { id: 'dewater', name: 'æ·±åº¦å»æ°´', icon: 'ğŸ’§', desc: 'ç§»é™¤å†—ä½™ç¯å¢ƒæå†™å’Œå¿ƒç†ç‹¬ç™½ï¼Œä¿ç•™åŸæ±åŸå‘³å¯¹è¯ä¸æ ¸å¿ƒå‰§æƒ…ã€‚' },
                { id: 'summary', name: 'å‰§æƒ…æ‘˜è¦', icon: 'ğŸ“', desc: 'å°†ç« èŠ‚å‹ç¼©ä¸ºæ ¸å¿ƒå¤§çº²ï¼Œä»…ä¿ç•™å…³é”®äº‹ä»¶èŠ‚ç‚¹ï¼Œæé€Ÿé˜…è¯»ã€‚' },
                { id: 'polish', name: 'æ–‡ç¬”æ¶¦è‰²', icon: 'âœ¨', desc: 'ä¸åˆ å‡å†…å®¹ï¼Œä»…ä¿®å¤è¯­ç—…ã€ä¼˜åŒ–è¯æ±‡ï¼Œæå‡æ–‡å­¦è´¨æ„Ÿã€‚' }
            ];

            // --- Computed ---
            const currentDisplayText = computed(() => {
                if (!activeBook.value) return [];

                if (isMagicActive.value) {
                    // æ ¹æ® activeModeName æ˜ å°„åˆ°æ•°æ® key
                    let modeKey = 'dewater';
                    if (activeBook.value.activeModeName === 'å‰§æƒ…æ‘˜è¦') modeKey = 'summary';
                    // å®é™…å¼€å‘ä¸­åº”è¯¥ç”¨ ID æ˜ å°„ï¼Œè¿™é‡Œç®€å•å¤„ç†
                    return activeBook.value.modes[modeKey] || activeBook.value.modes['dewater'];
                } else {
                    // å¦‚æœæœ‰åŸæ–‡æ•°æ®åˆ™æ˜¾ç¤ºåŸæ–‡ï¼Œæ²¡æœ‰åˆ™æ˜¾ç¤ºé»˜è®¤
                    return activeBook.value.modes['original'] || ["æ­£åœ¨åŠ è½½åŸæ–‡..."];
                }
            });

            // --- Methods ---

            // ä¹¦æ¶ç‚¹å‡»é€»è¾‘
            const handleBookClick = (book) => {
                tempBook.value = book;
                if (book.status === 'new') {
                    // æ–°ä¹¦ -> æ‰“å¼€é…ç½®
                    showConfigModal.value = true;
                } else if (book.status === 'processing') {
                    showToast('AI æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·ç¨å...');
                } else {
                    // å·²å°±ç»ª -> è¿›å…¥é˜…è¯»
                    activeBook.value = book;
                    isMagicActive.value = true; // é»˜è®¤å¼€å¯ç²¾ç®€
                    currentView.value = 'reader';
                }
            };

            // æ¨¡æ‹Ÿä¸Šä¼ 
            const triggerUpload = () => {
                const newBook = {
                    id: Date.now(),
                    title: 'æ–°ä¸Šä¼ çš„å°è¯´.txt',
                    lastChapter: 'æœªå¼€å§‹é˜…è¯»',
                    progress: 0,
                    status: 'new',
                    modes: {}
                };
                books.unshift(newBook);
                showToast('å¯¼å…¥æˆåŠŸ');
            };

            // å¼€å§‹ AI å¤„ç†æµç¨‹
            const startProcess = () => {
                showConfigModal.value = false;
                // æ›´æ–°ä¹¦ç±çŠ¶æ€
                const bookIndex = books.findIndex(b => b.id === tempBook.value.id);
                if (bookIndex !== -1) {
                    books[bookIndex].status = 'processing';
                    showToast('å·²åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ï¼Œå¼€å§‹åå°ç²¾ç®€');

                    // æ¨¡æ‹Ÿ 3ç§’åå®Œæˆ
                    setTimeout(() => {
                        books[bookIndex].status = 'ready';
                        // æ¨¡æ‹Ÿå¡«å……å‡æ•°æ®
                        books[bookIndex].activeModeName = availableModes.find(m => m.id === selectedModeId.value).name;
                        books[bookIndex].modes = books[0].modes; // å·æ‡’å¤åˆ¶ç¬¬ä¸€æœ¬ä¹¦çš„æ•°æ®ç”¨äºæ¼”ç¤º
                    }, 3000);
                }
            };

            // åˆ‡æ¢é˜…è¯»é¡µçš„é­”æ³•æ£’çŠ¶æ€
            const toggleMagic = () => {
                // åªæœ‰ ready çŠ¶æ€çš„ä¹¦æ‰æœ‰é­”æ³•
                if (activeBook.value.status !== 'ready') {
                    showToast('æš‚æ— ç²¾ç®€æ•°æ®');
                    return;
                }

                // ç®€å•çš„æ·¡å…¥æ·¡å‡ºé€»è¾‘
                isTextTransitioning.value = true;
                setTimeout(() => {
                    isMagicActive.value = !isMagicActive.value;
                    isTextTransitioning.value = false;
                    showToast(isMagicActive.value ? `âœ¨ å·²åˆ‡æ¢: ${activeBook.value.activeModeName}` : 'ğŸ“ å·²åˆ‡æ¢è‡³åŸæ–‡');
                }, 300);
            };

            // åœ¨è®¾ç½®ä¸­åˆ‡æ¢ç²¾ç®€æ¨¡å¼ (å¦‚ä» å»æ°´ -> æ‘˜è¦)
            const switchActiveMode = (modeKey) => {
                activeBook.value.activeModeName = getModeName(modeKey);
                // å¦‚æœé­”æ³•æ£’æ²¡å¼€ï¼Œè‡ªåŠ¨å¼€å¯
                if (!isMagicActive.value) {
                    isMagicActive.value = true;
                } else {
                    // è§¦å‘åˆ·æ–°åŠ¨ç”»
                    isTextTransitioning.value = true;
                    setTimeout(() => isTextTransitioning.value = false, 300);
                }
            };

            // å·¥å…·å‡½æ•°
            const getStatusText = (status) => {
                const map = { 'new': 'æœªå¤„ç†', 'processing': 'å¤„ç†ä¸­', 'ready': 'å·²ç²¾ç®€' };
                return map[status];
            };

            const getModeName = (key) => {
                const map = { 'dewater': 'å»æ°´æ¨¡å¼', 'summary': 'å‰§æƒ…æ‘˜è¦', 'original': 'åŸæ–‡', 'polish': 'æ¶¦è‰²æ¨¡å¼' };
                return map[key] || key;
            };

            return {
                currentView,
                books,
                tempBook,
                activeBook,
                showConfigModal,
                showSettings,
                menuVisible,
                isMagicActive,
                isTextTransitioning,
                selectedModeId,
                availableModes,
                currentDisplayText,
                toastVisible,
                toastMessage,
                handleBookClick,
                triggerUpload,
                startProcess,
                toggleMagic,
                getStatusText,
                switchActiveMode,
                getModeName
            };
        }
    }).mount('#app');
</script>
</body>
</html>