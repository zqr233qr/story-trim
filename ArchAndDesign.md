# 需求
- 本地离线阅读
- 缓存机制

# 分析
## 离线的优势
1. 不要求用户上传文本内容到服务器
2. 减少服务器存储成本
3. 减少流量宽带成本
4. 用户隐私性更好

## 离线的劣势
1. 没有用户体系，用户无法进行阅读记录的同步与书籍的同步
2. 使用精简功能难以实现缓存命中
3. 结合本地存储的需求对于不同平台支持不同，原生app支持sqllite，小程序不支持
4. 对于数据维护较为困难

# 解决方案
1. 小程序端无法支持本地离线 暂时不考虑离线方案，后续实现可以采用更加节约成本的方式使用，默认做用户体系
2. 原生app使用sqllite，接下来均分析原生app
3. 默认从服务器端获取书籍截取分章的正则，本地默认支持一直默认的书籍处理方法，触发时机，用户上传本地文件时
4. 书籍的解析在用户端，书籍内容不上云
5. 书籍的解析与处理，使用正则进行章节与内容的拆分，拆分后入库，保留原文内容及归一化md5
6. 书架功能，用户未登陆默认获取本地数据库中的书籍内容，登陆后额外请求服务端数据，获取用户上传的书籍内容，返回后前端进行合并，服务端返回的书籍信息均为已精简
7. 阅读功能的缓存，用户未登陆为避免后续的的缓存机制，统一使用内部缓存，不使用数据库作为缓存。
8. 需要封装一个方法当用户阅读的本书未精简全文(我们设计精简全文用户需要上传所有章节内容即服务器会为其开启多端同步的功能)，这时直接查询用户本地的数据库，如果用户精简了全文时先查询本地数据库，如果确实对应的精简内容再查询服务端获取精简内容保存到本地数据库与应用缓存中
9. 用户的阅读记录，默认存储在本地数据库，如果用户阅读的本书已经精简了全文这时，增加一个操作同时发送请求向服务端保存阅读记录

# 服务器端的数据库设计
1. 用户表 基本用户表即可，后续增加有特殊情况在扩展
2. 书籍表 基本字段 id, title, user_id, 书籍md5值, 第一章的归一化md5值, 存储路径(文件名称使用文件md5值, 可以为空用户精简时不上传), 章节数, 是否精简
3. 书籍章节表 id,book_id,章节的归一化md5值, 章节名称，章节下标, 章节字数, 预估token值
4. 章节内容表 章节归一化md5值, 章节内容
5. 章节精简内容表 章节归一化md5值, 精简模式id, 精简等级level 0=单独精简 1=全文精简, 精简内容, 精简后的字数, 精简内容剩余率, 消耗的token
6. 章节摘要表 书籍第一章的归一化md5值, 章节归一化md5值, 章节标题, 章节下标 摘要内容, 摘要字数
7. 书籍百科表 书籍第一章归一化md5值, 百科内容
8. 任务表 使用当前的tasks表即可
9. 书籍精简与精简模式的关联表
10. 提示词模板表(精简模式表) 使用当前的prompts表即可

# 前端本地离线数据库设计
1. 书籍表 基本字段id(与服务端无关, 自增), name ,md5, 第一章的归一化md5值, 章节数
2. 书籍章节表 基本字段id(与服务端无关，自增), 书籍id,第一章的归一化md5值, 章节归一化md5值, 章节名称, 章节下标, 章节原文内容
3. 书籍精简内容表 基本字段id(与服务端无关, 自增), 书籍id, 精简模式id, 精简内容


# 交互逻辑设计
## 上传接口
1. app上传，不调用服务端接口，app自己处理
2. 小程序上传，调用服务端接口，服务端进行文件内容的解析分章节、存储、整个文件进行md5、计算每章的预计token、每章的归一化md5值，每章的字数，及第一章作为本书的指纹等信息

## 精简单章接口
1. ws 连接
2. 处理逻辑，前端必须要登陆(包括app否则不允许使用精简模式), 前端上传书籍的md5、本章的md5值、精简模式的prompt_id与原文内容，服务端先根据md5与prompt_id查询是否有已经精简的优先使用level高的，存在以拟真流返回，不存在进行llm调用，并且写入库中，同时调用llm获取摘要，生成的摘要内容需要解析出来存入摘要库中
3. 精简完成后服务端需要记录用户的精简记录，书籍的md5、章节的md5与prompt_id，另外需要记录使用的token总值写到精简内容表中

## 精简全书
1. 用户必须登陆，携带精简模式的prompt_id
2. 小程序端直接使用之前存在库中的书籍的所有内容进行依次精简
3. app端需要上传所有的本地数据库中的章节内容及对应的md5值
4. 全文精简逻辑，优先查询库中是否有精简内容并且level=1的，存在即跳过，不存在则获取前文的摘要与百科，摘要暂时获取配置中写的N章，百科内容(可能没有，配置中定义每N章使用摘要进行生成)，结合这些内容调用llm，获取精简内容与摘要
5. 循环处理，记录消耗的每章token写入对应的精简内容表中

## 获取书架内容
1. 当用户登陆后才调用，在书架页
2. app端特殊处理，需要获取到的书籍信息与本地的信息进行合并，如果服务端返回的书籍的md5值与本地的某本书一直，说明这本书已经关联了云端，这时需要在之前设计的字段上进行绑定云端的book_id
