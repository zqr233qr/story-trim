## 表设计：
### 用户上传的书籍表
关键字段：id、用户id、第一章的归一化md5，标题(文件名称去除扩展名)、章节数

### 用户上传的章节表
关键字段：id、上传书籍id、归一化md5、标题、章节索引下标

### 原始章节内容表
关键字段：归一化md5、原始内容

### 精简内容表
关键字段：归一化md5、精简内容、prompt_id、version、 level(精简内容生成时使用的摘要、百科等信息映射而来，0-无摘要(存在部分摘要认定为不存在摘要要求摘要数=配置的摘要数(由程序计算而出))与百科、1-有摘要无百科、2-有摘要有百科)

### 内容摘要表
关键字段：归一化md5、摘要内容、书籍第一章的归一化md5、章节索引下标

### 百科表
关键字段：书籍第一章的归一化md5(作为主键)、百科内容(markdown格式)、百科状态(数字类型，由多少章进行处理的百科)

### 用户阅读记录表
关键字段：用户id、书籍id、章节id、prompt_id、version

### 用户精简记录表
关键字段：用户id、书籍id、章节id、prompt_id、version

### 上传接口
1. 用户上传txt文档 (后续需要支持多种格式如epub，需要设计一个接口使用合适的的设计模式进行选择进行后续处理)
2. 提取文档名称(去除后缀作为名称)
3. 提取文档内容解析出章节名称和内容(内容进行归一化去除标点及空行等一些与文字无关的信息进行md5)，存入数据库
4. 第一章的归一化md5作为百科的md5值标识为一本书(不存在则插入，存在跳过)，存入数据库
5. 处理结束之后返回章节列表

### 精简接口(流式输出)
1. 功能：精简一章内容并流式输出
2. 精简原理：
- 先查询系统中是否存在该章节的精简内容，存在直接返回(拟真流式输出)，不存在调用llm进行处理后返回
- 如何判断是否存在精简内容：查询精简内容表 where md5 = ? and prompt_id = ? and version = ? order by level desc limit 1 (获取精简级别最高的内容)
- 如果存在则返回(拟真流式输出)，不存在则调用llm进行处理并返回
- 调用llm处理逻辑: 查询用户上传的章节表 where id = ? 获取归一md5, 查询用户上传书籍表 where id = ? 获取第一章的归一化md5, 查询原内容表 where md5 = ? 获取内容, 查询内容摘要表 where 第一章的归一化md5 = ? and 下标 < (select 下标 from 摘要表 where md5 = ?) desc 下标 limit 配置的摘要数(由程序计算而出) 获取制定数量的摘要
- 继续llm处理逻辑: 查询百科表 where 一章的归一化md5 = ? and 百科状态 >= 文章下标 - 配置的每N章进行的百科间隔 获取百科内容
- 继续llm处理逻辑: if 摘要为空 或 摘要数量与程序要求数不同 and 百科为空 则 level=0，if 摘要数量与程序要求数不同 or 百科不为空 则 level=1，if 摘要数量与程序要求数相同 or 百科不为空 则 level=2
- 继续llm处理逻辑: 查询prompt表 where id = ?，获取prompt内容，注入必要参数，调用llm处理，返回结果，写入精简内容表, if 该章的摘要内容为空 then 摘要内容生成 (这里可以进行优化是否可以让ai生成精简内容的同时进行摘要内容的生成，这需要设计好提示词，让ai返回json格式)
- 实时llm处理需要流式返回

### 精简全文
1. 功能要求: 任务模式，后台执行
2. 原理：
- 查询用户上传的书籍对应的章节信息 循环查询
- 基本逻辑与精简一章类似，注意命中缓存的前提变成一定需要时level = 2
- 设计一套任务机制，前端触发后定时调用查看状态，精简完成后会改状态 需要增加一个任务表实现

### 查询某一章内容
1. 功能：查询某一章内容，返回章节原文及指定的精简内容
2. 原理：
- 只针对登陆用户，游客直接只返回原直接原文
- 查询获取原文内容
- 查询获取用户精简记录表 where 用户id = ? and 书籍id = ? and 章节id = ? and prompt_id = ? 注意这里不需要增加version，版本只针对于系统级别的修改，原用户依旧可以看到之前版本的精简内容
- 如果存在则进行查询精简缓存数据，查询不到不返回精简内容只返回原文，不存在亦然，注意记录upsert用户记录表

### 查询章节目录信息
1. 功能：查询章节目录信息，返回章节列表及对应的精简状态
2. 原理:
- 查询用户上传的章节表，查询用户精简记录表 where 用户id = ? and 书籍id = ? and prompt_id = ?, 数据处理合并
